# Stage 1: Build á»©ng dá»¥ng React (Vite)
build_app:
  stage: build
  # ğŸ’¡ ÄÃƒ Sá»¬A: NÃ¢ng cáº¥p lÃªn Node 20 Ä‘á»ƒ fix lá»—i EBADENGINE
  image: node:20-alpine
  script:
    - echo "Báº¯t Ä‘áº§u build React app (Vite)..."
    - npm install
    - npm run build # Lá»‡nh nÃ y sáº½ táº¡o ra thÆ° má»¥c 'dist/'
  artifacts:
    paths:
      # ğŸ’¡ ÄÃƒ Sá»¬A: Äá»•i tá»« build/ sang dist/
      - dist/
    expire_in: 1 hour
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "dev"'
      when: always
    - if: "$CI_PIPELINE_SOURCE =~ /merge_request|merge_request_event|merge_request_pipeline/"
      when: always
    - when: never

# Stage 2: Deploy lÃªn S3 vÃ  Invalidate CloudFront
deploy_to_s3:
  stage: deploy
  image:
    name: amazon/aws-cli:latest
    entrypoint: [""]
  needs: ["build_app"]
  script: |
    echo "Äá»“ng bá»™ file lÃªn S3 bucket: $S3_BUCKET_FRONTEND..."
    # ğŸ’¡ ÄÃƒ Sá»¬A: Äá»•i tá»« ./build sang ./dist
    aws s3 sync ./dist s3://$S3_BUCKET_FRONTEND --delete

    echo "Trigger CloudFront Invalidation cho Distribution: $CLOUDFONT_DISTRIBUTION_ID..."
    aws cloudfront create-invalidation --distribution-id $CLOUDFRONT_DISTRIBUTION_ID --paths "/*"

  environment:
    name: production
  only:
    - main
