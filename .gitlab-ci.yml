# Äá»‹nh nghÄ©a cÃ¡c bÆ°á»›c (stages) cá»§a pipeline
stages:
  - build
  - deploy

# Stage 1: Build á»©ng dá»¥ng React
build_app:
  stage: build
  # Sá»­ dá»¥ng image Node.js (báº£n 18, alpine lÃ  báº£n nháº¹)
  image: node:18-alpine 
  script:
    - echo "Báº¯t Ä‘áº§u build React app..."
    # CÃ i Ä‘áº·t dependencies (dÃ¹ng npm)
    # Náº¿u báº¡n dÃ¹ng Yarn, hÃ£y Ä‘á»•i 2 dÃ²ng sau thÃ nh:
    # - yarn install
    # - yarn build
    - npm install       
    - npm run build     # Lá»‡nh nÃ y sáº½ táº¡o ra thÆ° má»¥c 'build/'
  artifacts:
    paths:
      # LÆ°u láº¡i thÆ° má»¥c 'build' (káº¿t quáº£ cá»§a 'npm run build')
      - build/          
    expire_in: 1 hour   # Chá»‰ cáº§n lÆ°u táº¡m 1 tiáº¿ng Ä‘á»ƒ job 'deploy' dÃ¹ng
  only:
    - main              # Chá»‰ cháº¡y job nÃ y trÃªn branch 'main'

# Stage 2: Deploy lÃªn S3 vÃ  Invalidate CloudFront
deploy_to_s3:
  stage: deploy
  image: amazon/aws-cli:latest # DÃ¹ng image chÃ­nh thá»©c cá»§a AWS
  
  # ğŸ’¡ Sá»¬A Lá»–I á» ÄÃ‚Y:
  # Ghi Ä‘Ã¨ entrypoint cá»§a image. Image nÃ y máº·c Ä‘á»‹nh cÃ³ entrypoint lÃ  "aws",
  # chÃºng ta reset nÃ³ vá» "" Ä‘á»ƒ GitLab Runner cÃ³ thá»ƒ cháº¡y shell (sh -c "...")
  entrypoint: [""]

  needs: ["build_app"]         # Cháº¡y sau khi 'build_app' thÃ nh cÃ´ng
  script: |
    # 1. Äá»“ng bá»™ thÆ° má»¥c 'build' (tá»« job 'build_app') lÃªn S3
    echo "Äá»“ng bá»™ file lÃªn S3 bucket: $S3_BUCKET_NAME..."
    aws s3 sync ./build s3://$S3_BUCKET_NAME --delete

    # 2. Trigger CloudFront Invalidation
    echo "Trigger CloudFront Invalidation cho Distribution: $CLOUDFONT_DISTRIBUTION_ID..."
    aws cloudfront create-invalidation --distribution-id $CLOUDFONT_DISTRIBUTION_ID --paths "/*"
  
  environment:
    name: production 
  only:
    - main